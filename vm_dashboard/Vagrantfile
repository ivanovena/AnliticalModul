# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/focal64"
  config.vm.hostname = "dashboard-vm"
  
  # Configuraci칩n para acceder a la red del host
  config.vm.network "public_network", bridge: "en0: Wi-Fi (AirPort)"
  
  # Redireccionar puerto del dashboard
  config.vm.network "forwarded_port", guest: 3000, host: 3001
  
  config.vm.provider "virtualbox" do |vb|
    vb.memory = "4096"
    vb.cpus = 2
    vb.gui = true
    vb.customize ["modifyvm", :id, "--vram", "128"]
    vb.customize ["modifyvm", :id, "--graphicscontroller", "vmsvga"]
  end

  # Compartir carpeta del proyecto
  config.vm.synced_folder "../", "/home/vagrant/project7"

  # Script de aprovisionamiento para instalar entorno gr치fico y herramientas
  config.vm.provision "shell", inline: <<-SHELL
    export DEBIAN_FRONTEND=noninteractive
    apt-get update
    # Instalar entorno de escritorio XFCE (ligero)
    apt-get install -y xfce4 xfce4-goodies
    # Instalar herramientas necesarias para el dashboard
    apt-get install -y curl git build-essential net-tools iputils-ping
    # Instalar Node.js y npm
    curl -fsSL https://deb.nodesource.com/setup_16.x | bash -
    apt-get install -y nodejs
    # Instalar Docker y Docker Compose
    apt-get install -y docker.io
    curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    chmod +x /usr/local/bin/docker-compose
    # Agregar usuario vagrant al grupo docker
    usermod -aG docker vagrant
    # Instalar Chrome para acceder al dashboard
    wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    apt-get install -y ./google-chrome-stable_current_amd64.deb
    
    # Obtener la IP del host para facilitar el acceso a los servicios Docker
    HOST_IP=$(ip route | grep default | awk '{print $3}')
    echo "export HOST_IP=$HOST_IP" >> /home/vagrant/.bashrc
    
    # Crear script de inicio autom치tico para el dashboard
    cat > /home/vagrant/start_dashboard.sh << EOF
#!/bin/bash
cd /home/vagrant/project7/web
npm install
echo "Usando la IP del host para acceder a los servicios: \$HOST_IP"
echo "Configurando variables de entorno para conectarse a los servicios Docker en el host..."
export REACT_APP_API_BASE_URL="http://\$HOST_IP:5000"
export REACT_APP_WS_URL="ws://\$HOST_IP:8000"
npm start
EOF
    chmod +x /home/vagrant/start_dashboard.sh
    
    # Crear script para ejecutar el frontend desde Docker si lo prefiere
    cat > /home/vagrant/start_docker_dashboard.sh << EOF
#!/bin/bash
cd /home/vagrant/project7
docker-compose up -d dashboard
echo "Dashboard en Docker iniciado. Accesible en http://localhost:3000"
EOF
    chmod +x /home/vagrant/start_docker_dashboard.sh
    
    # Crear icono de escritorio para lanzar el dashboard
    mkdir -p /home/vagrant/.config/autostart
    cat > /home/vagrant/Desktop/Dashboard.desktop << EOF
[Desktop Entry]
Type=Application
Name=Trading Dashboard
Comment=Launch Trading Dashboard
Exec=/home/vagrant/start_dashboard.sh
Icon=terminal
Terminal=true
Categories=Development;
EOF
    chmod +x /home/vagrant/Desktop/Dashboard.desktop
    
    # Crear icono para dashboard en Docker
    cat > /home/vagrant/Desktop/Dashboard-Docker.desktop << EOF
[Desktop Entry]
Type=Application
Name=Trading Dashboard (Docker)
Comment=Launch Trading Dashboard using Docker
Exec=/home/vagrant/start_docker_dashboard.sh
Icon=docker
Terminal=true
Categories=Development;
EOF
    chmod +x /home/vagrant/Desktop/Dashboard-Docker.desktop
    
    chown -R vagrant:vagrant /home/vagrant/Desktop
    chown -R vagrant:vagrant /home/vagrant/*.sh
    
    echo "La VM est치 lista para ejecutar el dashboard. La IP del host es \$HOST_IP"
    echo "Para conectarse a los servicios Docker del host, use esa IP."
  SHELL
end